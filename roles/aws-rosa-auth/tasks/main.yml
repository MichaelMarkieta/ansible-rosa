---
- name: ensure aws_access_key_id exist for rosa profile
  ini_file:
    path: "{{ ansible_env.HOME }}/.aws/credentials"
    section: default
    option: aws_access_key_id
    value: "{{ aws_access_key_id }}"
  when: aws_access_key_id != "" and aws_access_key_id != None

- name: ensure aws_secret_access_key exist for rosa profile
  ini_file:
    path: "{{ ansible_env.HOME }}/.aws/credentials"
    section: default
    option: aws_secret_access_key
    value: "{{ aws_secret_access_key }}"
  when: aws_secret_access_key != "" and aws_secret_access_key != None

- name: ensure default region is set for rosa profile
  ini_file:
    path: "{{ ansible_env.HOME }}/.aws/config"
    section: default
    option: region
    value: "{{ aws_default_region }}"
  when: aws_default_region != "" and aws_default_region != None

- name: verify aws permissions
  command: aws sts get-caller-identity
  changed_when: false

- name: check if rosa is logged in (a changed result means no)
  command: rosa list clusters
  failed_when: false
  register: _rosa_has_token
  changed_when: _rosa_has_token.stderr is search("Not logged in")

- name: authenticate rosa using token
  rosa_auth:
    token: "{{ rosa_token }}"
  when: _rosa_has_token.stderr is search("Not logged in")

- name: initialize rosa
  rosa_init:
    state: present
  changed_when: false